<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nourish Connection</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <!-- Bulma CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css"
    />

    <!-- style css -->
    <link
      href="{{ url_for('static', filename='assets/colors/colors.css') }}"
      rel="stylesheet"
    />
    <link
      href="{{ url_for('static', filename='assets/font-style/font-style.css') }}"
      rel="stylesheet"
    />

    <!-- AJAX -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-1234567890abcdefg..."
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <link
    href="//maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
    rel="stylesheet"
    />

    <!-- Poppins Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Golos+Text:wght@500;900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <script>
      $(document).ready(function(){
        get_posts();
      })
      function post() {
        let topik = $("#topik-post").val();
        let today = new Date().toISOString();
        $.ajax({
          type: "POST",
          url: "/posting",
          data: {
            topik_give: topik,
            date_give: today,
          },
          success: function (response) {
            $("#modal-post").removeClass("is-active");
            window.location.reload();
          },
        });
      }
      function time2str(date) {
        let today = new Date();
        let time = (today - date) / 1000 / 60;
        if (time < 60) {
          return parseInt(time) + " minutes ago";
        }
        time = time / 60;
        if (time < 24) {
          return parseInt(time) + " hours ago";
        }
        time = time / 24;
        if (time < 7) {
          return parseInt(time) + " days ago";
        }
        let year = date.getFullYear();
        let month = date.getMonth() + 1;
        let day = date.getDate();

        return `${year}.${month}.${day}`;
      }

      function num2str(count) {
        if (count > 10000) {
          return parseInt(count / 1000) + "k";
        }

        if (count > 500) {
          //1000 -> 100 -> 1 + k
          //550 -> 5 -> 0.5 + k
          return parseInt(count / 100) / 10 + "k";
        }

        if (count == 0) {
          return "";
        }

        return count;
      }


      function get_posts(username) {
        if (username === undefined) {
          username = "";
        }
        $("#post-box").empty();
        $.ajax({
          type : 'GET',
          url : `/get_posts?username_give=${username}`,
          data : {},
          success : function(response) {
            if (response["result"] === "success"){
              let username_post = '{{ user_info.username }}'
              let posts = response["posts"];
              console.log(posts)
              for (let i = 0; i < posts.length; i++) {
                let post = posts[i];
                let time_post = new Date(post["date"]);
                let time_before = time2str(time_post);
                let class_thumbsup = post["thumbsup_by_me"]
                  ? "fa-thumbs-up"
                  : "fa-thumbs-o-up";
                let class_comment = post["comment_by_me"]
                  ? "fa-comment"
                  : "fa-thumbs-o-up";
              
                let html_temp = `
                  <div class="box border rounded-lg" id="${post["_id"]}">
                      <div class="card-body">
                        <h6 class="heading-color fw-bold is-black">${post["nama_usaha"]}</h6>
                        <small class="is-black">${time_before}</small>
                        <p class="mt-3 mb-md-0 mb-lg-2 is-black">
                          ${post["topik"]}
                        </p>
                      </div>
                      <div
                        class="card-footer is-bg-blue border-0 pb-4 d-lg-flex align-items-center justify-content-between pb-5"
                      >
                      
                        <div class="level-left">
                          <a 
                              class="level-item is-blue"
                              aria-label="thumbsup"
                              onclick="toggle_thumbsup('${post["_id"]}','thumbsup')">
                              <span class="icon is-small">
                              <i class="fa ${class_thumbsup}" area-hidden="true"></i>
                              </span>&nbsp;<span class="like-num">${num2str(
                                post["count_thumbsup"]
                              )}</span>
                          </a>
                          <a 
                              class="level-item is-blue"
                              aria-label="comment"
                              onclick="">
                              <span class="icon is-small">
                              <i class="fa-regular fa-comment" area-hidden="true"></i>
                              </span>&nbsp;<span class="comment-num">100
                              </span>
                          </a>
                        </div>
                        ${post["username"] === username_post ? `
                          <button class="btn btn-danger rounded-pill px-4" onclick="delete_post()">Hapus</button>
                        ` : `
                          <button class="btn btn-danger rounded-pill px-4 is-hidden">Hapus</button>
                        `}
                      </div>
                  </div>
                  `;
          $("#post-box").append(html_temp);
        }
            }
          }
        })
      }

      function toggle_thumbsup(post_id, type) {
        let $a_like = $(`#${post_id} a[aria-label = 'thumbsup']`);
        let $i_like = $a_like.find("i");

        if ($i_like.hasClass("fa-thumbs-up")) {
          $.ajax({
            type: "POST",
            url: "/update_like",
            data: {
              post_id_give: post_id,
              type_give: type,
              action_give: "unlike",
            },
            success: function (response) {
              $i_like.addClass("fa-thumbs-o-up").removeClass("fa-thumbs-up");
              $a_like.find("span.like-num").text(num2str(response["count"]));
            },
          });
        } else {
          $.ajax({
            type: "POST",
            url: "/update_like",
            data: {
              post_id_give: post_id,
              type_give: type,
              action_give: "like",
            },
            success: function (response) {
              $i_like.addClass("fa-thumbs-up").removeClass("fa-thumbs-o-up");
              $a_like.find("span.like-num").text(num2str(response["count"]));
            },
          });
        }
      }

      function delete_post(){
        let username_post = '{{ user_info.username }}'
        let topik_post = post["topik"]
        $.ajax({
          type : 'POST',
          url : '/delete_post',
          data : {
            username_give : username_post,
            topik_give : topik_post
          },
          success : function(response){
            if (response.result === 'success'){
              alert(response.msg);
              location.reload();
            }else{
              alert('Something went wrong')
            }
          }
        })
      }
    </script>
  </head>
  <body>
    <!-- Navbar Start -->
    <nav class="navbar" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">
        <a class="navbar-item" href="/">
          <img
            src="{{url_for('static', filename='assets/logo/logo-text-blue.png')}}"
            width="100"
          />
        </a>

        <a
          role="button"
          class="navbar-burger"
          aria-label="menu"
          aria-expanded="false"
          data-target="navbarBasicExample"
        >
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
          <span aria-hidden="true"></span>
        </a>
      </div>

      <div id="navbarBasicExample" class="navbar-menu">
        <div class="navbar-end">
          <div class="navbar-start">
            <a class="navbar-item" href="/tentang_nourish"> Tentang Nourish </a>
            <a class="navbar-item" href="/umkm_list"> UMKM </a>
            {% if 'username' in session %}
            <a class="navbar-item" href="/diskusi"> Diskusi UMKM </a>
            {% else %}
            <a class="navbar-item is-hidden" href="/diskusi"> Diskusi UMKM </a>
            {% endif %}
          </div>
          <div class="navbar-item">
            {% if 'username' in session %} {% if user_info is defined %}
            <div class="buttons">
              <a
                class="button is-button-orange"
                href="/user/{{ user_info.username }}"
              >
                Profil
              </a>
            </div>
            {% endif %} {% else %}
            <div class="buttons">
              <a class="button is-button-orange" href="/login"> Masuk </a>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>
    <!-- Navbar Stop -->

    <!-- Section Input Post Start -->
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-10 my-3 text-center">
          <h1 class="fs-2 fw-bold">MULAI BERDISKUSI DISINI</h1>
          <div class="media-content mt-3">
            <div class="field">
              <p class="control">
                <input
                  id="input-post"
                  class="input is-rounded"
                  placeholder="Tulis topik diskusi kamu"
                  onclick='$("#modal-post").addClass("is-active")'
                />
  
                <div class="modal" id="modal-post">
                  <div class="modal-background" onclick="$('#modal-post').removeClass('is-active')">
                  </div>
                  <div class="modal-content">
                    <div class="box">
                      <article class="media">
                        <div class="media-content">
                          <div class="field">
                            <p class="control">
                              <textarea 
                              id="topik-post" 
                              class="textarea" 
                              placeholder="Tulis topik diskusi kamu"/></textarea>
                            </p>
                          </div>
                          <nav class="level is-mobile">
                            <div class="level-left"></div>
                            <div class="level-right">
                              <div class="level-item">
                                <a class="button is-sparta" onclick="post()">
                                Create post
                                </a>
                              </div>
                              <div class="level-item">
                                <a class="button is-sparta is-outlined" onclick="$('#modal-post').removeClass('is-active')">
                                Cancel
                                </a>
                              </div>
                            </div>
                          </nav>
                        </div>
                      </article>
                    </div>
                  </div>
                  <button class="modal-close is-large" aria-label="close" onclick="$('#modal-post').removeClass('is-active')">
                  </button>
                </div>
               </p>
            </div>
          </div>
        </div>

        <div class="col-10" id="post-box">
          

          <div
            class="card is-bg-blue text-white shadow px-4 px-md-2 px-lg-3 card-span pt-5 border-0 mt-3"
          >
            <div class="card-body">
              <h6 class="heading-color fw-bold is-black">Nama umkm</h6>
              <small class="is-black"> 1 Menit</small>
              <p class="mt-3 mb-md-0 mb-lg-2 is-black">
                is simply dummy text of the printing and typesetting industry.
                Lorem Ipsum has been the industry's standard dummy text ever
                since the 1500s,
              </p>
            </div>
            <div
              class="card-footer is-bg-blue border-0 pb-4 d-lg-flex align-items-center justify-content-between pb-5"
            >
              <div class="div">
                <a href="">Like <i class="bi bi-hand-thumbs-up"></i></a>
                <a href="">Komen <i class="bi bi-chat-left-dots"></i></a>
              </div>
              <button class="btn btn-danger rounded-pill px-4">Hapus</button>
            </div>
          </div>

          <div
            class="card is-bg-blue text-white shadow px-4 px-md-2 px-lg-3 card-span pt-5 border-0 mt-3"
          >
            <div class="card-body">
              <h6 class="heading-color fw-bold is-black">Nama umkm</h6>
              <small class="is-black"> 1 Menit</small>
              <p class="mt-3 mb-md-0 mb-lg-2 is-black">
                is simply dummy text of the printing and typesetting industry.
                Lorem Ipsum has been the industry's standard dummy text ever
                since the 1500s,
              </p>
            </div>
            <div
              class="card-footer is-bg-blue border-0 pb-4 d-lg-flex align-items-center justify-content-between pb-5"
            >
              <div class="div">
                <a href="">Like <i class="bi bi-hand-thumbs-up"></i></a>
                <a href="">Komen <i class="bi bi-chat-left-dots"></i></a>
              </div>
              <button class="btn btn-danger rounded-pill px-4">Hapus</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Section Input Post Stop -->
    <footer class="my-5">
      <div class="content has-text-centered">
        <p class="is-blue">2023 Nourish Connection</p>
      </div>
    </footer>
  </body>
</html>
